#!/bin/bash

# ===============================================
# setup_asterisk.sh ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Asterisk –¥–ª—è "–ê—Å–∏"
# –î–ª—è –ø—Ä–æ–µ–∫—Ç–∞: –ù–µ–π—Ä–æ–∑–≤–æ–Ω–∏–ª–∫–∞ "–ê—Å—è"
# ===============================================

set -e  # –ü—Ä–µ—Ä–≤–∞—Ç—å –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

echo "üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –Ω–µ–π—Ä–æ–∑–≤–æ–Ω–∏–ª–∫–∏ '–ê—Å—è'..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –æ—Ç root
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå –û–®–ò–ë–ö–ê: –°–∫—Ä–∏–ø—Ç –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç –∏–º–µ–Ω–∏ root (sudo)"
  exit 1
fi

# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_DIR="/opt/asya_ari_mvp"  # ‚Üê –ò–ó–ú–ï–ù–ò–¢–ï –ù–ê –ü–£–¢–¨ –ö –í–ê–®–ï–ú–£ –ü–†–û–ï–ö–¢–£!
ASTERISK_CONF_DIR="/etc/asterisk"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -d "$PROJECT_DIR" ]; then
  echo "‚ùå –ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $PROJECT_DIR"
  echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω –≤ /opt/asya_ari_mvp"
  exit 1
fi

# –°–æ–∑–¥–∞—ë–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..."
[ -f "$ASTERISK_CONF_DIR/extensions.conf" ] && cp "$ASTERISK_CONF_DIR/extensions.conf" "$ASTERISK_CONF_DIR/extensions.conf.bak-$(date +%Y%m%d-%H%M%S)"
[ -f "$ASTERISK_CONF_DIR/sip.conf" ] && cp "$ASTERISK_CONF_DIR/sip.conf" "$ASTERISK_CONF_DIR/sip.conf.bak-$(date +%Y%m%d-%H%M%S)"

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥–∏ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ –≤ Asterisk
echo "üì• –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π..."
cp -v "$PROJECT_DIR/asterisk_configs/extensions.conf" "$ASTERISK_CONF_DIR/"
cp -v "$PROJECT_DIR/asterisk_configs/sip.conf" "$ASTERISK_CONF_DIR/"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å
if [ ! -f "$ASTERISK_CONF_DIR/extensions.conf" ] || [ ! -f "$ASTERISK_CONF_DIR/sip.conf" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏!"
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–Ω—Ñ–∏–≥–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤..."
if ! asterisk -rx "core show config" > /dev/null 2>&1; then
  echo "‚ùå –û–®–ò–ë–ö–ê –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Asterisk! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
  tail -n 20 /var/log/asterisk/full
  exit 1
fi

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Asterisk
echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Asterisk..."
asterisk -rx "core reload"

# –ñ–¥—ë–º 3 —Å–µ–∫—É–Ω–¥—ã
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é SIP-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SIP-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞..."
sip_status=$(asterisk -rx "sip show registry" | grep -v "^$" | tail -n +2)

if [ -z "$sip_status" ]; then
  echo "‚ö†Ô∏è  WARNING: SIP-–ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ sip.conf —É–∫–∞–∑–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ credentials."
else
  echo "‚úÖ SIP-–ø—Ä–æ–≤–∞–π–¥–µ—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:"
  echo "$sip_status"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É ARI
echo "üîå –ü—Ä–æ–≤–µ—Ä–∫–∞ ARI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è 'asya_app'..."
ari_apps=$(asterisk -rx "ari apps list" | grep -i asya_app)
if [ -n "$ari_apps" ]; then
  echo "‚úÖ ARI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ 'asya_app' –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: $ari_apps"
else
  echo "‚ö†Ô∏è  ARI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ 'asya_app' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ ari.conf –µ—Å—Ç—å —Å–µ–∫—Ü–∏—è [asya_app] –∏ –ø–∞—Ä–æ–ª—å —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ."
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∏–∞–ª–ø–ª–∞–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç
echo "üìû –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ 'neuro_calls'..."
dialplan_check=$(asterisk -rx "dialplan show neuro_calls" 2>/dev/null | head -n 5)
if [ -n "$dialplan_check" ]; then
  echo "‚úÖ –î–∏–∞–ª–ø–ª–∞–Ω 'neuro_calls' –∑–∞–≥—Ä—É–∂–µ–Ω:"
  echo "$dialplan_check"
else
  echo "‚ùå –î–∏–∞–ª–ø–ª–∞–Ω 'neuro_calls' –Ω–µ –Ω–∞–π–¥–µ–Ω!"
fi

# –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –ª–æ–≥–∏
echo ""
echo "üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤ Asterisk:"
tail -n 10 /var/log/asterisk/full

echo ""
echo "üéâ –ì–æ—Ç–æ–≤–æ! –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è '–ê—Å–∏' –ø—Ä–∏–º–µ–Ω–µ–Ω–∞."
echo "üëâ –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏—Ç–µ FastAPI-—Å–µ—Ä–≤–∏—Å (—Å–º. start_service.sh)"
echo "üëâ –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞ –Ω–æ–º–µ—Ä ‚Äî –∑–≤–æ–Ω–æ–∫ –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –≤ ARI."