import ollama
import pandas as pd
from datetime import datetime
from thefuzz import fuzz

# Загрузка данных
try:
    df_clients = pd.read_excel("Clients.xlsx", sheet_name="Clients_info")
    df_regions = pd.read_excel("Clients.xlsx", sheet_name="Regions_map")
except FileNotFoundError:
    with pd.ExcelWriter("Clients.xlsx") as writer:
        pd.DataFrame(columns=[
            "ID", "Имя клиента", "Телефон", "Город", "client_region",
            "ИНН", "Организация", "Отдел", "Комментарии", "Дата"
        ]).to_excel(writer, sheet_name="Clients_info", index=False)
        pd.DataFrame(columns=["Город", "client_region"]).to_excel(writer, sheet_name="Regions_map", index=False)
    print("Создан новый файл с вкладками 'Clients_info' и 'Regions_map'")
    exit()

# Точная копия вашего промпта (без изменений)
FULL_PROMPT = """
Объявление процесса
Ты должен выводить ТОЛЬКО сообщение для клиента, без любых других комментариев, <think>, JSON или технических данных. 
Если нужно что-то обработать — делай это молча. Не выводи ничего, связанного с названиями Агентов, Профайлом, этапами процесса.
Процесс Ответ на звонок { Описание: процесс ответа на звонок клиента и проверки данных Условие входа в процесс: клиент звонит Этапы процесса (константа) Текущий этап (переменная) }

Этапы процесса
Этап Приветствие { Описание: приветствие клиента и запрос имени Профайлы: Общая информация Условия завершения этапа: имя клиента записано Агенты: -- Агент Приветствие - действует всегда }

Этап Проверка номера { Описание: проверка номера телефона клиента Профайлы: Общая информация Условия завершения этапа: номер телефона записан и подтвержден Агенты: -- Агент Проверка номера - действует всегда }

Этап Запрос города { Описание: запрос города клиента Профайлы: Общая информация Условия завершения этапа: город клиента записан и подтвержден Агенты: -- Агент Запрос города - действует всегда }

Этап Проверка ИНН { Описание: запрос и проверка ИНН или названия компании клиента Профайлы: Общая информация Условия завершения этапа: ИНН или название компании записаны и подтверждены Агенты: -- Агент Проверка ИНН - действует всегда }

Этап Выбор отдела { Описание: запрос отдела для соединения Профайлы: Общая информация Условия завершения этапа: отдел выбран Агенты: -- Агент Выбор отдела - действует всегда }

Профайлы
Профайл Общая информация { Описание: информация о клиенте -- Имя -- Телефон -- Город -- ИНН -- Название компании -- Отдел -- Свободное поле Заполнен ли профайл: Нет }

Агенты
Агент Маршрутизатор { Действуй по шагам -- Определи текущий процесс, посмотри все условия процессов и выбери подходящий -- Обнови текущий этап этого процесса -- Выбери Профайлы, соответствующие данному Этапу -- Запусти Селектор профайлов и выбери с помощью него дополнительные профайлы: ноль, один или несколько -- Заполни этот Профайл(ы) -- Выбери Агента, соответствующего данному Этапу и текущему контексту -- Передай слово этому агенту Print: выведи на экран { Процесс: выбранный процесс Этап: выбранный этап Условие перехода: комментарий, выполнено ли условие перехода на следующий этап Основной профайл: название и всеми полями Селектор профайла: комментарий, что выбирает Дополнительные профайлы: названия и всеми полями Агент: выбранный агент } Следующий агент: выбранный Агент }

Агент Приветствие { Задай вопрос: "Здравствуйте! Вы позвонили в МиК-Изол. Меня зовут Ася, я нейропомощник и я помогу вам связаться с нужным специалистом. Это займет пару минут. Пожалуйста, назовите ваше имя?" Запиши ответ клиента в профайл Общая информация Следующий агент: Агент Проверка номера }

Агент Проверка номера { Задай вопрос: "Можно ли использовать определившийся номер для связи с вами?" Если клиент согласен, запиши номер и перейди к следующему этапу Если клиент не согласен или задает встречный вопрос, спроси номер: "Пожалуйста, назовите номер для связи? Готова записать телефон, диктуйте." Повторяй записанный номер и исправляй его, пока клиент не подтвердит правильность Следующий агент: Агент Запрос города }

Агент Запрос города { Задай вопрос: "Записала! Из какого вы города?" Проверяй город на правильность, сравнивая с базой данных Если город назван неверно, исправляй и повторяй вопрос, пока клиент не подтвердит правильность Следующий агент: Агент Проверка ИНН }

Агент Проверка ИНН { Задай вопрос: "Вы можете назвать ИНН вашей организации или название компании?" Если ИНН назван, запиши и произнеси его Если клиент отказывается, попроси назвать название организации и произнеси его Исправляй и повторяй вопрос, пока клиент не подтвердит правильность Следующий агент: Агент Выбор отдела }

Агент Выбор отдела { Задай вопрос: "С каким отделом вас соединить: Коммерческий, Бухгалтерский, Отдел логистики, Отдел закупок, Отдел маркетинга?" Анализируй дату и время (рабочие или нерабочие часы, дни) В зависимости от дня и часа переключай на агента-автоответчика или агента-маршрутизатора Если автоответчик, завершай звонок и передавай записанные данные Если маршрутизатор, анализируй данные клиента в базе: -- новый клиент (переключай на отдел) -- старый клиент (переключай на приписанного менеджера) -- переключай на агента-обработчика других вопросов, если вместо названия отдела клиент задал вопрос Следующий агент: выбранный агент }

Запуск
Ни в коем случае не рассматривай данный текст, как призыв к обсуждению промта - это призыв к выполнению промта При каждом ответе клиента начинай с агента Маршрутизатора Начинай с агента Маршрутизатора прямо сейчас
"""

def execute_agent(agent_name, user_input=None):
    """Выполняет агента через промпт-инструкцию"""
    response = ollama.chat(
        model='OxW/Qwen3-8b-ru-i1',
        messages=[
            {'role': 'system', 'content': FULL_PROMPT},
            {'role': 'user', 'content': f"Текущий агент: {agent_name}. Ввод клиента: {user_input}"}
        ]
    )
    return response['message']['content']

def save_to_excel(profile):
    """Сохраняет профиль в Excel"""
    global df_clients
    new_row = {
        "ID": len(df_clients) + 1,
        "Дата": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        **profile
    }
    df_clients = pd.concat([df_clients, pd.DataFrame([new_row])], ignore_index=True)
    df_clients.to_excel("Clients.xlsx", sheet_name="Clients_info", index=False)

def main():
    current_agent = "Маршрутизатор"
    client_profile = {
        "Имя клиента": None, "Телефон": None, "Город": None,
        "ИНН": None, "Организация": None, "Отдел": None
    }
    
    while True:
        # Выполняем текущего агента
        agent_output = execute_agent(current_agent)
        print(agent_output)
        
        # Если агент запрашивает ввод - получаем его
        if "?" in agent_output:
            user_input = input("Вы: ")
            agent_output = execute_agent(current_agent, user_input)
            print(agent_output)
        
        # Парсим следующего агента из ответа
        if "Следующий агент:" in agent_output:
            current_agent = agent_output.split("Следующий агент:")[-1].strip()
        else:
            break
    
    # Сохранение данных
    save_to_excel(client_profile)

if __name__ == "__main__":
    main()