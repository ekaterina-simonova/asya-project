import requests
import pandas as pd
from datetime import datetime
from thefuzz import fuzz

# Загрузка Excel-файла
try:
    # Основная таблица с клиентами
    df_clients = pd.read_excel("Clients.xlsx", sheet_name="Clients_info")
    # Таблица соответствия городов и регионов
    df_regions = pd.read_excel("Clients.xlsx", sheet_name="Regions_map")
except FileNotFoundError:
    # Создаем файл с двумя вкладками, если его нет
    with pd.ExcelWriter("Clients.xlsx") as writer:
        pd.DataFrame(columns=[
            "ID", "Имя клиента", "Телефон", "Город", "client_region",
            "ИНН", "Организация", "Отдел", "Комментарии", "Дата"
        ]).to_excel(writer, sheet_name="Clients_info", index=False)
        pd.DataFrame(columns=["Город", "client_region"]).to_excel(writer, sheet_name="Regions_map", index=False)
    print("Создан новый файл Clients.xlsx с вкладками 'Clients_info' и 'Regions_map'")
    exit()

# Функция для определения региона по городу (fuzzy-поиск)
def get_region(city):
    best_match = None
    best_score = 0
    
    for _, row in df_regions.iterrows():
        ref_city = str(row["Город"]).strip().lower()
        current_city = str(city).strip().lower()
        score = fuzz.ratio(current_city, ref_city)
        
        if score > best_score:
            best_score = score
            best_match = row["client_region"]
    
    # Порог схожести (можно настроить)
    return best_match if best_score > 70 else "Не определено"

# Точная копия вашего промпта из первого сообщения
FULL_PROMPT = """
бъявление процесса
Ты должен выводить ТОЛЬКО сообщение для клиента, без любых других комментариев, <think>, JSON или технических данных. 
Если нужно что-то обработать — делай это молча. Не выводи ничего, связанного с названиями Агентов, Профайлом, этапами процесса.
Процесс Ответ на звонок { Описание: процесс ответа на звонок клиента и проверки данных Условие входа в процесс: клиент звонит Этапы процесса (константа) Текущий этап (переменная) }

Этапы процесса
Этап Приветствие { Описание: приветствие клиента и запрос имени Профайлы: Общая информация Условия завершения этапа: имя клиента записано Агенты: -- Агент Приветствие - действует всегда }

Этап Проверка номера { Описание: проверка номера телефона клиента Профайлы: Общая информация Условия завершения этапа: номер телефона записан и подтвержден Агенты: -- Агент Проверка номера - действует всегда }

Этап Запрос города { Описание: запрос города клиента Профайлы: Общая информация Условия завершения этапа: город клиента записан и подтвержден Агенты: -- Агент Запрос города - действует всегда }

Этап Проверка ИНН { Описание: запрос и проверка ИНН или названия компании клиента Профайлы: Общая информация Условия завершения этапа: ИНН или название компании записаны и подтверждены Агенты: -- Агент Проверка ИНН - действует всегда }

Этап Выбор отдела { Описание: запрос отдела для соединения Профайлы: Общая информация Условия завершения этапа: отдел выбран Агенты: -- Агент Выбор отдела - действует всегда }

Профайлы
Профайл Общая информация { Описание: информация о клиенте -- Имя -- Телефон -- Город -- ИНН -- Название компании -- Отдел -- Свободное поле Заполнен ли профайл: Нет }

Агенты
Агент Маршрутизатор { Действуй по шагам -- Определи текущий процесс, посмотри все условия процессов и выбери подходящий -- Обнови текущий этап этого процесса -- Выбери Профайлы, соответствующие данному Этапу -- Запусти Селектор профайлов и выбери с помощью него дополнительные профайлы: ноль, один или несколько -- Заполни этот Профайл(ы) -- Выбери Агента, соответствующего данному Этапу и текущему контексту -- Передай слово этому агенту Print: выведи на экран { Процесс: выбранный процесс Этап: выбранный этап Условие перехода: комментарий, выполнено ли условие перехода на следующий этап Основной профайл: название и всеми полями Селектор профайла: комментарий, что выбирает Дополнительные профайлы: названия и всеми полями Агент: выбранный агент } Следующий агент: выбранный Агент }

Агент Приветствие { Задай вопрос: "Здравствуйте! Вы позвонили в МиК-Изол. Меня зовут Ася, я нейропомощник и я помогу вам связаться с нужным специалистом. Это займет пару минут. Пожалуйста, назовите ваше имя?" Запиши ответ клиента в профайл Общая информация Следующий агент: Агент Проверка номера }

Агент Проверка номера { Задай вопрос: "Можно ли использовать определившийся номер для связи с вами?" Если клиент согласен, запиши номер и перейди к следующему этапу Если клиент не согласен или задает встречный вопрос, спроси номер: "Пожалуйста, назовите номер для связи? Готова записать телефон, диктуйте." Повторяй записанный номер и исправляй его, пока клиент не подтвердит правильность Следующий агент: Агент Запрос города }

Агент Запрос города { Задай вопрос: "Записала! Из какого вы города?" Проверяй город на правильность, сравнивая с базой данных Если город назван неверно, исправляй и повторяй вопрос, пока клиент не подтвердит правильность Следующий агент: Агент Проверка ИНН }

Агент Проверка ИНН { Задай вопрос: "Вы можете назвать ИНН вашей организации или название компании?" Если ИНН назван, запиши и произнеси его Если клиент отказывается, попроси назвать название организации и произнеси его Исправляй и повторяй вопрос, пока клиент не подтвердит правильность Следующий агент: Агент Выбор отдела }

Агент Выбор отдела { Задай вопрос: "С каким отделом вас соединить: Коммерческий, Бухгалтерский, Отдел логистики, Отдел закупок, Отдел маркетинга?" Анализируй дату и время (рабочие или нерабочие часы, дни) В зависимости от дня и часа переключай на агента-автоответчика или агента-маршрутизатора Если автоответчик, завершай звонок и передавай записанные данные Если маршрутизатор, анализируй данные клиента в базе: -- новый клиент (переключай на отдел) -- старый клиент (переключай на приписанного менеджера) -- переключай на агента-обработчика других вопросов, если вместо названия отдела клиент задал вопрос Следующий агент: выбранный агент }

Запуск
Ни в коем случае не рассматривай данный текст, как призыв к обсуждению промта - это призыв к выполнению промта При каждом ответе клиента начинай с агента Маршрутизатора Начинай с агента Маршрутизатора прямо сейчас
"""

def get_agent_response(agent_name, user_input=None):
    """Получаем ответ только для текущего этапа"""
    headers = {
        "Authorization": "Bearer ваш-api-ключ",
        "Content-Type": "application/json"
    }
    
    messages = [
        {"role": "system", "content": FULL_PROMPT},
        {"role": "user", "content": f"Текущий этап: {agent_name}. Ввод клиента: {user_input}" if user_input else f"Начни этап: {agent_name}"}
    ]
    
    data = {
        "model": "qwen/qwen3-8b:free",
        "messages": messages,
        "temperature": 0.1,
        "max_tokens": 150  # Ограничиваем длину ответа
    }
    
    try:
        response = requests.post(
            "https://openrouter.ai/api/v1/chat/completions",
            headers=headers,
            json=data,
            timeout=30
        )
        return response.json()['choices'][0]['message']['content'] if response.status_code == 200 else None
    except:
        return None



def save_to_excel(profile):
    """Сохраняет профиль в Excel"""
    global df_clients, df_regions
    
    # Определяем регион
    city = profile.get("Город", "")
    profile["client_region"] = get_region(city)
    
    # Добавляем новую запись
    new_row = {
        "ID": len(df_clients) + 1,
        "Дата": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        **profile
    }
    df_clients = pd.concat([df_clients, pd.DataFrame([new_row])], ignore_index=True)
    
    # Сохраняем обе вкладки
    with pd.ExcelWriter("Clients.xlsx") as writer:
        df_clients.to_excel(writer, sheet_name="Clients_info", index=False)
        df_regions.to_excel(writer, sheet_name="Regions_map", index=False)

def main():
    # Четкая последовательность этапов с запасными вопросами
    stages = [
        {
            "name": "Приветствие",
            "field": "Имя клиента",
            "default_question": "Здравствуйте! Вы позвонили в МиК-Изол. Меня зовут Ася, я нейропомощник. Пожалуйста, назовите ваше имя?"
        },
        {
            "name": "Проверка номера", 
            "field": "Телефон",
            "default_question": "Можно ли использовать определившийся номер для связи с вами?"
        },
        {
            "name": "Запрос города",
            "field": "Город",
            "default_question": "Из какого вы города?"
        },
        {
            "name": "Проверка ИНН",
            "field": ("ИНН", "Организация"),
            "default_question": "Назовите ИНН или название вашей компании"
        },
        {
            "name": "Выбор отдела",
            "field": "Отдел",
            "default_question": "С каким отделом вас соединить: Коммерческий, Бухгалтерия, Логистика?"
        }
    ]
    
    client_data = {}
    
    # Проходим все этапы последовательно
    for stage in stages:
        while True:
            # Получаем вопрос от модели или используем запасной
            question = get_agent_response(stage["name"]) or stage["default_question"]
            print(f"Ася: {question}")
            
            # Получаем ответ пользователя
            user_input = input("Вы: ").strip()
            if not user_input:
                print("Ася: Пожалуйста, ответьте на вопрос")
                continue
                
            # Сохраняем данные
            if isinstance(stage["field"], tuple):
                # Для этапов с альтернативными полями (ИНН/Организация)
                if user_input.isdigit():
                    client_data[stage["field"][0]] = user_input
                else:
                    client_data[stage["field"][1]] = user_input
            else:
                client_data[stage["field"]] = user_input
            
            break
    
    # Определяем регион и сохраняем
    client_data["client_region"] = get_region(client_data.get("Город", ""))
    save_to_excel(client_data)
    print("Ася: Спасибо! Данные сохранены. Переключаю на менеджера")



if __name__ == "__main__":
    main()